package com.mangni.vegaplan.jobscheduling;

import java.text.ParseException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.Map;
import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import com.mangni.vegaplan.datatable.EnumGoodsTypes;
import com.mangni.vegaplan.servletsrc.gang.GangBattleSite;
import com.mangni.vegaplan.toolshelper.Bean;
import com.mangni.vegaplan.toolshelper.GetGoodsHelper;
import com.mangni.vegaplan.toolshelper.LvupHelper;
import com.mangni.vegaplan.toolshelper.MyJdbcTemplate;
import com.mangni.vegaplan.toolshelper.SendMessageHelper;

public class GangBattleMinBalance implements Job {

	@Override
	public void execute(JobExecutionContext arg0) throws JobExecutionException {
		MyJdbcTemplate myJdbcTemplate=(MyJdbcTemplate) Bean.getCtx().getBean("myJdbcTemplate");
		List<Map<String,Object>> ganginfolist=myJdbcTemplate.queryForList("select * from player_ganginfo where ischecked=1");
		for(Map<String,Object> ganginfomap:ganginfolist){
			int rate=1;
			List<Integer> gangpostioncount=new ArrayList<Integer>();
			String playerid=String.valueOf(ganginfomap.get("playerid"));
			String positiontime=String.valueOf(ganginfomap.get("positiontime"));
			int positionx=Integer.parseInt(String.valueOf(ganginfomap.get("battlepositionx")));
			int positiony=Integer.parseInt(String.valueOf(ganginfomap.get("battlepositiony")));
			if(positionx==0){
				return;
			}
			int[] positionparam={positionx,positiony};
			if("null".equals(positiontime)){
				try {
					Calendar positiondate=Calendar.getInstance();
					Calendar now=Calendar.getInstance();
					positiondate.setTime(Bean.getDateFormat().parse(positiontime));
					positiondate.setFirstDayOfWeek(Calendar.MONDAY);
					now.setFirstDayOfWeek(Calendar.MONDAY);
					if(now.get(Calendar.DAY_OF_WEEK)==Calendar.SATURDAY||now.get(Calendar.DAY_OF_WEEK)==Calendar.SUNDAY)
						rate=2;

					positiondate.add(Calendar.HOUR_OF_DAY, -1);//1小时余量
					now.add(Calendar.HOUR_OF_DAY, -1);//1小时余量

					if(!GangBattleSite.isSameDate(positiondate, now)){//是否处于同一周内
						positionparam=GangBattleSite.initPosition(playerid,myJdbcTemplate);
					}
				} catch (ParseException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}else{
				positionparam=GangBattleSite.initPosition(playerid,myJdbcTemplate);
			}
			positionx=positionparam[0];
			positiony=positionparam[1];
			int positionsum=10*positionx+positiony;
			if(positionx>=4&&positiony<=4&&positionx-positiony<=3){//堡垒区
				//给星钻，给军团经验，写入军团message
				GetGoodsHelper.getGoods(playerid, EnumGoodsTypes.STONE, "0", String.valueOf(5*rate));
				SendMessageHelper.sendGangMessage(Bean.getZnx_gangmap().get(String.valueOf(ganginfomap.get("gangid"))), playerid, "5" ,String.valueOf(10*rate), 1);
				if(!gangpostioncount.contains(positionsum)){
					LvupHelper.addGangExp(String.valueOf(ganginfomap.get("gangid")), 100, 0, new ArrayList<String>());
					SendMessageHelper.sendGangMessage(Bean.getZnx_gangmap().get(String.valueOf(ganginfomap.get("gangid"))), "0", "6" ,"100", 1);
					gangpostioncount.add(positionsum);
				}
			}else if(!(positionx==1&&(positionx==7&&(positiony==1||positiony==7)))){//据点区
				//给星钻，给军团经验，写入军团message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
				GetGoodsHelper.getGoods(playerid, EnumGoodsTypes.STONE, "0", String.valueOf(5*rate));
				SendMessageHelper.sendGangMessage(Bean.getZnx_gangmap().get(String.valueOf(ganginfomap.get("gangid"))), playerid, "5" ,String.valueOf(10*rate), 1);
				if(!gangpostioncount.contains(positionsum)){
					LvupHelper.addGangExp(String.valueOf(ganginfomap.get("gangid")), 50, 0, new ArrayList<String>());
					SendMessageHelper.sendGangMessage(Bean.getZnx_gangmap().get(String.valueOf(ganginfomap.get("gangid"))), "0", "6" ,"50", 1);
					gangpostioncount.add(positionsum);
				}
			}


		}

	}

}
